# 📊 데이터 분석

## **✍️ DAY 05**

## 🕵️‍♂️ 이상값 탐지 및 처리

## 💡 개요

- 이상값은 단순히 제거 대상이 아님
- **데이터 품질 문제**일 수도 있지만, **비즈니스 기회**일 수도 있음
- 통계, 머신러닝, 도메인 지식 기반 규칙을 **종합적으로 적용**해 판별

---

## 📈 탐지 프로세스

1. **일변량 탐지 (IQR 방법)**
    - 각 변수별 사분위수 범위를 벗어난 값 탐지
2. **다변량 탐지 (마할라노비스 거리)**
    - 변수 간 상관관계 고려, 정규분포 가정
3. **다변량 탐지 (Isolation Forest)**
    - 비정규·고차원 데이터에 강점
4. **비즈니스 규칙 기반**
    - 예: 나이 ≤ 130세, 마지막 구매일 ≥ 0, 평균구매액 ≤ 1천만 원
5. **최종 종합 판정**
    - 2개 이상 방법에서 이상값으로 판정 시 **최종 이상값**

---

## 💻 코드 예시

```python
summary, final_outliers = outlier_detection(
    df_knn,
    chi_q=0.99,      # 마할라노비스 거리 임계값
    iso_cont=0.05,   # Isolation Forest contamination 비율
    final_threshold=2 # 최종 이상값 판정 기준
)
```

**📝 출력 예시**

```
1. IQR 이상값: age(1.1%), avg_order_value(7.0%) ...
2. 마할라노비스 거리: 이상값 2.3%
3. Isolation Forest: 이상값 5.0%
4. 비즈니스 규칙: 이상값 0.6%
== 최종 이상값: 4.4%
```

---

## 🤔 이상값 해석 예시

| 변수 | 정상 평균 | 이상 평균 | 차이배수 |
| --- | --- | --- | --- |
| age | 35.1 | 102.3 | ×2.9 |
| avg_order_value | 111.4 | 503.7 | ×4.5 |
| loyalty_points | 115.2 | 486.0 | ×4.2 |

---

## 🛠️ 처리 전략

- **VIP 고객** → 마케팅 대상 지정
- **데이터 오류** → 결측 처리 또는 수정
- **휴면 고객** → 재활성화 캠페인 대상
- **극단 구매액** → Winsorizing (상위 1% 제한)

```python
df_treated = execute_outlier_treatment(df_mice, final_outliers)
```

---

## ⭐ 실무 포인트

- 통계 방법 + 규칙 기반 탐지 병행
- 이상값을 제거하기 전에 의미 분석 필수
- 처리 로직은 함수화·자동화해 재사용 가능하게 설계
- 처리 전후 데이터·모델 영향 비교 필요