# 📊 데이터 분석

## ✍️ DAY 04

## 🔎 결측치 탐지 및 처리

## 📋 데이터 개요

- **전자상거래 데이터** 모사 (고객 정보 + 구매 행동 + 만족도 + 충성도 + 카테고리별 구매액)
- **결측치 메커니즘** 반영:
    - **MCAR**: 무작위 결측 (시스템 오류)
    - **MAR**: 조건부 결측 (나이 높을수록 만족도 미응답)
    - **MNAR**: 비무작위 결측 (고소득자 개인정보 비공개)
- **이상치 예시**:
    - 입력 오류: `age = 999`
    - 비즈니스 극단값: VIP 고객 초고액 구매
    - 시스템 버그: 음수 값

---

## 🤔 결측치 메커니즘 이해

| 유형 | 정의 | 예시 | 특징 |
| --- | --- | --- | --- |
| **MCAR** | 완전 무작위 결측 | 임의 시스템 오류 | 분석 편향 없음, 단순 처리 가능 |
| **MAR** | 조건부 무작위 결측 | 고령층 만족도 응답 거부 | 조건 변수 포함해 대체 필요 |
| **MNAR** | 비무작위 결측 | 고소득자 개인정보 비공개 | 대체 어려움, 특수 기법/민감도 분석 필요 |

---

## ⚖️ 결측치 대체 기법 비교

| 방법 | 특징 | 장점 | 단점 |
| --- | --- | --- | --- |
| **평균 대체** | 각 변수 평균값으로 대체 | 빠름 | 분산 감소, 왜곡 가능 |
| **KNN 대체** | 유사한 데이터(이웃) 기준 | 자연스러운 대체 | 계산 비용 ↑ |
| **MICE 대체** | 다변량 회귀 반복 적용 | 변수 관계 반영 | 구현 난이도↑, 계산량↑ |

**💡 대체 후 평가 필수**:

- 변수 분포 변화
- 주요 통계량 비교
- 상관관계 보존도 확인

---

## 🕵️‍♀️ 결측값 패턴 분석

**💡 분석 항목**:

1. 변수별 결측수/결측률 집계
2. 결측값 히트맵 시각화
3. 변수별 결측률 Bar Chart
4. 결측 조합 패턴 상위 10개 빈도
5. 결측 여부(0/1) ↔ 수치형 변수 상관관계 히트맵

```python
analyze_missing_patterns(ecommerce)
```

**📝 시각화 예시**:

- 히트맵: 결측 분포 직관 확인
- 바 차트: 결측률 비교
- 패턴 조합: 특정 변수군 결측 동시 발생 여부
- 상관 히트맵: 결측 여부와 다른 변수 간 관계

---

## 🩺 결측 메커니즘 진단

### 💰 Age 결측 → 구매액 관계

- **카이제곱 검정**으로 MAR/MCAR 여부 판별
- 구매액 분위별 나이 결측률 비교

```python
chi2_contingency(con_table)  # p-value < 0.05 → MAR 가능성
```

### 😊 만족도 결측 패턴

- 연령대별(`~30`, `31~50`, `50+`) 결측률
- 성별별 결측률
- 결측률이 특정 그룹에서 높으면 **MAR 가능성**

---

## 🛠️ 대체 방법 적용

```python
# 평균 대체
SimpleImputer(strategy='mean')

# KNN 대체
KNNImputer(n_neighbors=5)

# MICE 대체
IterativeImputer(random_state=42, max_iter=10)
```

**📜 적용 순서**:

1. 결측률 확인
2. 각 대체 기법 적용
3. 시각화로 결과 비교 (분포 변화 관찰)
4. 통계량 비교 (mean, std)

---

## 📝 대체 결과 시각화 예시

- **변수:** `age`
- 대체 전/후 히스토그램 비교
- 각 방법별 통계량 표로 출력

```python
sns.histplot(df_numeric['age'], label='원본')
sns.histplot(df_mean['age'], label='평균대체', alpha=0.3)
```

---

## ✅ 대체 품질 평가

**📏 평가 기준**:

1. **분포 보존 성능**
    - 평균차이(%), 표준편차차이(%)
2. **상관관계 보존 성능**
    - 예: `age` ↔ `avg_order_value`
    - 보존도(%) = 100 - (|원본 - 대체| / |원본| × 100)

```python
# 결과 예시
방법     변수             평균차이(%)   표준편차차이(%)
KNN대체  age             1.25         2.14
MICE대체 satisfaction    0.87         1.90
```

---

## ✔️ 정리

- 결측치 메커니즘 이해(MCAR/MAR/MNAR)가 **대체 전략 선택**의 핵심
- **평균 → KNN → MICE** 순으로 정밀도·계산비용 증가
- 대체 후 **분포·상관관계 평가** 필수
- 이상치 처리 역시 결측치 처리와 병행 권장